{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Checkout</h1>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h3>Order Summary</h3>
                </div>
                <div class="card-body">
                    <ul class="list-group mb-3">
                        {% for item in order.order_items %}
                        <li class="list-group-item d-flex justify-content-between">
                            <div>
                                <h6 class="my-0">{{ item.product.name }}</h6>
                                <small class="text-muted">Quantity: {{ item.quantity }}</small>
                            </div>
                            <span class="text-muted">KES {{ "%.2f"|format(item.quantity * item.price_at_time) }}</span>
                        </li>
                        {% endfor %}
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Total (KES)</span>
                            <strong>KES {{ "%.2f"|format(order.total_price) }}</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3>M-Pesa Payment</h3>
                </div>
                <div class="card-body">
                    <form id="paymentForm">
                        <div class="form-group mb-3">
                            <label for="phone_number">Phone Number</label>
                            <input type="text" class="form-control" id="phone_number" name="phone_number"
                                   placeholder="e.g., 0712345678" required>
                            <small class="text-muted">Enter the M-Pesa number to receive payment prompt</small>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="payButton">
                            Pay with M-Pesa
                        </button>
                    </form>
                    <div id="paymentStatus" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <p>Payment initiated! Please check your phone for the M-Pesa prompt.</p>
                            <p>Once you complete the payment, you will be redirected automatically.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('paymentForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const payButton = document.getElementById('payButton');
    const statusDiv = document.getElementById('paymentStatus');

    payButton.disabled = true;
    payButton.innerHTML = 'Processing...';

    fetch('/initiate_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'phone_number': document.getElementById('phone_number').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.style.display = 'block';
            // Poll for payment status
            pollPaymentStatus(data.checkout_request_id);
        } else {
            alert(data.message);
            payButton.disabled = false;
            payButton.innerHTML = 'Pay with M-Pesa';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        payButton.disabled = false;
        payButton.innerHTML = 'Pay with M-Pesa';
    });
});

function pollPaymentStatus(checkoutRequestId) {
    const statusDiv = document.getElementById('paymentStatus');
    const messageDiv = statusDiv.querySelector('.alert');
    const payButton = document.getElementById('payButton');
    let attempts = 0;
    const maxAttempts = 60; // Poll for 5 minutes maximum

    messageDiv.className = 'alert alert-info';
    messageDiv.innerHTML = '<p>Payment initiated! Please check your phone for the M-Pesa prompt.</p>' +
                          '<p>Waiting for payment confirmation...</p>';

    const pollInterval = setInterval(() => {
        attempts++;
        fetch(`/check_payment_status/${checkoutRequestId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'Completed') {
                    clearInterval(pollInterval);
                    messageDiv.className = 'alert alert-success';
                    messageDiv.innerHTML = '<p>Payment successful! Redirecting to order confirmation...</p>';
                    setTimeout(() => {
                        window.location.href = `/order_confirmation/${data.order_id}`;
                    }, 2000);
                } else if (data.status === 'Failed') {
                    clearInterval(pollInterval);
                    messageDiv.className = 'alert alert-danger';
                    messageDiv.innerHTML = `<p><strong>Payment Failed:</strong> ${data.message}</p>` +
                                         '<p>Please try again or use a different phone number.</p>';
                    payButton.disabled = false;
                    payButton.innerHTML = 'Pay with M-Pesa';
                } else if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    messageDiv.className = 'alert alert-warning';
                    messageDiv.innerHTML = '<p>Payment status check timed out.</p>' +
                                         '<p>If you completed the payment, please contact support.</p>';
                    payButton.disabled = false;
                    payButton.innerHTML = 'Pay with M-Pesa';
                } else {
                    // Still pending
                    messageDiv.innerHTML = '<p>Waiting for payment confirmation...</p>' +
                                         '<p>Please complete the payment on your phone if you haven\'t already.</p>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageDiv.className = 'alert alert-warning';
                messageDiv.innerHTML = '<p>Error checking payment status.</p>' +
                                     '<p>Please wait or contact support if you\'ve completed the payment.</p>';
            });
    }, 5000);
}
</script>
{% endblock %}